<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>SimpleBus/MessageBus</title>

        <link rel="stylesheet" href="//simplebus.github.io/MessageBus/css/bootstrap.min.css">
        <link rel="stylesheet" href="//simplebus.github.io/MessageBus/css/font-awesome.min.css">
        <link rel="stylesheet" href="//simplebus.github.io/MessageBus/css/highlight.dark.css">
        <link rel="stylesheet" href="//simplebus.github.io/MessageBus/css/main.css">
    </head>
    <body>

        <header class="navbar navbar-default navbar-fixed-top">

            <a class="navbar-brand" href="https://simplebus.github.io/MessageBus/">
                SimpleBus/MessageBus
                <small class="hidden-xs hidden-sm">
                    Generic classes and interfaces for command and event buses
                </small>
            </a>


        </header>

        <main class="container-fluid">
            <div class="row">


                    <nav id="sidebar" class="col-sm-3 col-lg-2" role="navigation">

                        <ul class="nav nav-pills nav-stacked">
                                                            <li class="">
                                    <a href="https://simplebus.github.io/MessageBus/">
                                        Home
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simplebus.github.io/MessageBus/doc/getting_started.html">
                                        Getting started
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simplebus.github.io/MessageBus/doc/command_bus.html">
                                        Command bus
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simplebus.github.io/MessageBus/doc/event_bus.html">
                                        Event bus
                                    </a>
                                </li>
                                                            <li class="active">
                                    <a href="https://simplebus.github.io/MessageBus/doc/message_recorder.html">
                                        Recording events
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simplebus.github.io/MessageBus/doc/upgrade_guide.html">
                                        Upgrade guide
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simplebus.github.io/DoctrineORMBridge/">
                                        Doctrine ORM integration
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simplebus.github.io/SymfonyBridge/">
                                        Symfony integration
                                    </a>
                                </li>
                                                    </ul>

                    </nav>


                <section id="content" class="col-sm-offset-3 col-lg-offset-2 col-sm-9 col-lg-10">
                    <h1 id="recording-events">Recording events and handling them</h1>
<p>While the <a href="#command-bus">command bus</a> handles a command, certain events will take place. It might be important to
<em>record these events</em> and, when the command has been fully handled, notify other parts of the system about the events
that were recorded.</p>
<p>This can be accomplished by using <em>message recorders</em>. These are objects with the ability to record messages. From the
outside these messages can be retrieved, and erased:</p>
<pre><code class="language-php">interface ContainsRecordedMessages
{
    public function recordedMessages();

    public function eraseMessages();
}</code></pre>
<h2>Collecting events</h2>
<h3 id="publicly-recorded-messages">Publicly</h3>
<p>The default implementation, which has a public <code>record()</code> method as well, is the <code>PublicMessageRecorder</code>:</p>
<pre><code class="language-php">use SimpleBus\Message\Recorder\PublicMessageRecorder;

$publicMessageRecorder = new PublicMessageRecorder();

$event = new UserRegistered(...);

$publicMessageRecorder-&gt;record($event);

$recordedEvents = $publicMessageRecorder-&gt;recordedEvents();
// $recordedEvents is an array containing the previously recorded $event object</code></pre>
<h3>Privately</h3>
<p>When you use domain events, your domain entities will generate events while you change them. You record those events
inside the entity. Later, when the changes have been persisted and the database transaction has succeeded, you should
collect the recorded events and handle them:</p>
<pre><code class="language-php">$entity-&gt;changeSomething();
// $entity generates a SomethingChanged event and records it internally

// start transaction
$entityManager-&gt;persist($entity);
// commit transaction

$events = $entity-&gt;recordedEvents();

// handle the events
foreach ($events as $event) {
    $eventBus-&gt;handle($event);
}</code></pre>
<p>You can give your entities the ability to record their own events by letting them implement the <code>RecordsMessages</code>
interface and using the <code>PrivateMessageRecorderCapabilities</code> trait:</p>
<pre><code class="language-php">use SimpleBus\Message\Recorder\RecordsMessages;
use SimpleBus\Message\Recorder\PrivateMessageRecorderCapabilities;

class YourEntity implements RecordsMessages
{
    use PrivateMessageRecorderCapabilities;

    public function changeSomething()
    {
        ...

        $this-&gt;record(new SomethingChanged());
    }
}</code></pre>
<h2>Handling events</h2>
<h3>Handling publicly recorded events</h3>
<p>Events are recorded while a command is handled. We only want to handle the events themselves <em>after</em> the command has
been completely and successfully been handled. The best option to accomplish this is to add a piece of middleware to the
command bus. This middleware needs the <em>message recorder</em> to find out which events were recorded during the
handling of a command, and it needs the <em>event bus</em> to actually handle the recorded events:</p>
<pre><code class="language-php">use SimpleBus\Message\Recorder\HandlesRecordedMessagesMiddleware;

$commandBus-&gt;appendMiddleware(new HandlesRecordedMessagesMiddleware(
    $publicMessageRecorder,
    $eventBus
));</code></pre>
<p>Make sure to add this middleware <em>first</em>, before adding any other middleware. Like mentioned before: we only want events
to be handled when we know that everything else has gone well.</p>
<h2>Handling domain events</h2>
<p>When you privately record events inside your domain entities, you need to collect those recorded events manually. Your
database abstraction library, ORM or ODM probably offers a way to hook into the process of persisting the entities and
collecting them somehow. After the command has been handled successfully and the transaction has been committed,
you can iterate over those entities and collect their recorded events.</p>
<blockquote>
<h4>Handling domain events with Doctrine ORM</h4>
<p>SimpleBus comes with a <a href="https://github.com/SimpleBus/DoctrineORMBridge">Doctrine ORM bridge</a>. Using this package you
can collect recorded events from Doctrine ORM entities. See its
<a href="https://github.com/SimpleBus/DoctrineORMBridge/blob/master/README.html">README</a> file for further instructions.</p>
</blockquote>
<h2>Combining multiple message recorders</h2>
<p>If you have multiple ways in which you record events, e.g. using the <code>PublicMessageRecorder</code> and using domain events,
you can combine those into one message recorder, which aggregates the recorded messages:</p>
<pre><code class="language-php">use SimpleBus\Message\Recorder\AggregatesRecordedMessages;

$aggregatingMessageRecorder(
    [
        $publicMessageRecorder,
        $domainEventsMessagesRecorder,
        ...
    ]
)</code></pre>
<p>Finally, you can provide this aggregating message recorder to the <code>HandlesRecordedMessagesMiddleware</code> and it will act as
if it is a single message recorder.</p>
<pre><code class="language-php">$commandBus-&gt;appendMiddleware(new HandlesRecordedMessagesMiddleware(
    $aggregatingMessageRecorder,
    $eventBus
));</code></pre>
                </section>

            </div>
        </main>

        <footer>
            <div class="container-fluid">
                <p class="text-muted">
                    website generated with <a href="http://couscous.io" title="Markdown website generator">Couscous</a>
                </p>
            </div>
        </footer>

        <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
        <script src="//yastatic.net/highlightjs/8.2/highlight.min.js"></script>

        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');
                // Syntax highlighting
                hljs.initHighlightingOnLoad();
            });
        </script>

    </body>
</html>
